var canvas,ctx,activeSequence=1,doAnimate=!1,sequenceOne={rect:{width:20,height:1},type:{size:0,spacing:0},circleRadius:5,rotation:0},sequenceTwo={circleOne:0,circleTwo:0,circleThree:0},sequenceThree={x:0};function createAnimationCanvas(){(canvas=document.createElement("canvas")).id="animationCanvas",ctx=canvas.getContext("2d"),canvas.width=width,canvas.height=height,jQuery("#animationCanvas").append(canvas)}var mobileAdd=0;function startAnimationSequence(){doAnimate=!0,width<=640&&(mobileAdd=50),sequence_one()}function activateButtons(){var e=.2*width;jQuery("#backgroundBox").css({width:e,height:e}),jQuery("#interactiveBox").css({opacity:1,left:width-.12*width-e/2,top:height/2-e/2}),jQuery(".interactiveDot").each(function(e){jQuery(this).bind("click",buttonClicked);var t=getRandomInt(20,50);jQuery(this).css({width:t,height:t})}),rePositionDots()}function rePositionDots(){var e=.2*width;jQuery(".interactiveDot").each(function(t){jQuery(this).css({marginTop:getRandomInt(100-e,100),marginLeft:getRandomInt(-50,e)})})}var lastState,lastInteraction,backgroundPlane,imageCount=12,buttonClicks=0;function buttonClicked(e){for(lastInteraction=new Date,didReset=!1,TweenLite.killTweensOf(window),TweenLite.killTweensOf(changeAnimation),TweenLite.killTweensOf(camPos),e=getRandomInt(1,7);e==lastState;)e=getRandomInt(1,7);if(lastState=e,rePositionDots(),2==e)TweenLite.to(monolith.children[0].children[0].material,2,{opacity:0,ease:Expo.easeIn}),TweenLite.to(backgroundPlane.children[0].material,2,{opacity:0,ease:Expo.easeIn});else{for(var t=getRandomInt(0,imageCount);t==activeImage;)t=getRandomInt(0,imageCount);changeTexture(imagePath+t+".jpg")}if(3!=e&&1!=e||(sequenceOne={rect:{width:20,height:1},type:{size:0,spacing:0},circleRadius:5,rotation:0},sequence_one("3")),2==e&&sequence_one("4"),4!=e&&7!=e||(sequenceOne={rect:{width:20,height:1},type:{size:0,spacing:0},circleRadius:5,rotation:0},TweenLite.to(sequenceOne.rect,0,{height:1,delay:2,ease:Back.easeOut}),TweenLite.to(sequenceOne.rect,2,{width:.4*width+3*mobileAdd,delay:2,ease:Back.easeOut}),TweenLite.to(sequenceOne,2,{circleRadius:.1*width+mobileAdd,delay:2.5,ease:Quad.easeOut}),TweenLite.to(sequenceOne,2,{rotation:-45,delay:2,ease:Back.easeOut})),5!=e&&6!=e||(TweenLite.to(sequenceOne.rect,2,{width:0,delay:2,ease:Back.easeOut}),TweenLite.to(sequenceOne,2,{circleRadius:1e-4,delay:2,ease:Quad.easeOut})),4==buttonClicks){for(t=getRandomInt(0,imageCount);t==activeImage;)t=getRandomInt(0,imageCount);changeTexture(imagePath+t+".jpg"),kaleidoActive=!0}kaleidoActive=6==e&&buttonClicks>2,buttonClicks++}function sequence_one(e){e=e||"0",sequenceOne.type.spacing=.6*width*.105,TweenLite.to(sequenceOne.rect,2,{width:.6*width,delay:1,ease:Back.easeOut,onComplete:function(){TweenLite.to(sequenceOne.rect,1,{height:100,ease:Quad.easeOut}),TweenLite.to(sequenceOne,2,{circleRadius:.01*width,ease:Back.easeOut,onComplete:function(){TweenLite.to(sequenceOne.rect,2,{width:1,delay:1.5,ease:Expo.easeOut}),"4"!=e&&(TweenLite.to(sequenceOne.type,2,{size:0,spacing:0,delay:1.5,ease:Back.easeOut}),TweenLite.to(sequenceOne,2,{rotation:45,delay:1.5,ease:Back.easeOut}),TweenLite.to(sequenceOne,2,{circleRadius:4,delay:1.5,ease:Back.easeOut,onComplete:function(){"0"==e&&(TweenLite.to(window,2.16,{data:.3,ease:Back.easeIn,onComplete:function(){changeTexture(imagePath+activeImage+".jpg")}}),TweenLite.to(sequenceOne.rect,0,{height:1,delay:2,ease:Back.easeOut}),TweenLite.to(sequenceOne.rect,2,{width:.4*width+3*mobileAdd,delay:2,ease:Back.easeOut}),TweenLite.to(sequenceOne,2,{circleRadius:.1*width+mobileAdd,delay:2.5,ease:Quad.easeOut}),TweenLite.to(sequenceOne,2,{rotation:-45,delay:2,ease:Back.easeOut,onComplete:function(){sequence_two(),TweenLite.to(sequenceOne.rect,2,{width:0,delay:2,ease:Back.easeOut}),TweenLite.to(sequenceOne,2,{circleRadius:1e-4,delay:2,ease:Quad.easeOut}),TweenLite.to(window,2,{data:.3,ease:Back.easeIn,onComplete:function(){doHoverMonolith=!0}})}}))}}))}})}}),width<=640?TweenLite.to(sequenceOne.type,2,{size:.03*width,ease:Back.easeIn}):TweenLite.to(sequenceOne.type,2,{size:30,ease:Back.easeIn})}function sequence_two(){TweenLite.to(sequenceTwo,1.8,{circleOne:.13*width+mobileAdd,delay:2,ease:Back.easeOut}),TweenLite.to(sequenceTwo,1.4,{circleTwo:.1*width+mobileAdd,delay:2,ease:Back.easeOut}),TweenLite.to(sequenceTwo,1,{circleThree:.07*width+mobileAdd,delay:2,ease:Back.easeOut,onComplete:function(){addInfoAnimation()}})}function sequence_three(){sequenceThree.x=width/2,TweenLite.to(sequenceThree,1.8,{x:width-.12*width,ease:Back.easeOut}),TweenLite.to(sequenceTwo,1.6,{circleOne:.13*width+mobileAdd,ease:Back.easeOut}),TweenLite.to(sequenceTwo,1.2,{circleTwo:.1*width+mobileAdd,ease:Back.easeOut}),TweenLite.to(sequenceTwo,1,{circleThree:.07*width+mobileAdd,ease:Back.easeOut,onComplete:function(){}})}function animateCanvas(){if(doAnimate){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.lineWidth=1;var e={x:width/2,y:height/2},t=sequenceOne.rect.width,n=sequenceOne.rect.height;ctx.save(),ctx.translate(e.x,e.y),ctx.rotate(radians(sequenceOne.rotation)),ctx.translate(-e.x,-e.y),ctx.strokeStyle="#ffffff",ctx.beginPath(),ctx.rect(e.x-t/2,e.y-n/2,t,n),ctx.stroke(),ctx.restore();var a="MONOLITH";ctx.font="100 "+sequenceOne.type.size+"px Roboto",ctx.fillStyle="#ffffff";for(var i=0;i<a.length;i++)ctx.fillText(a[i],e.x-t/2+sequenceOne.type.spacing+i*sequenceOne.type.spacing,e.y+10);0==sequenceOne.rotation?(ctx.beginPath(),ctx.fillStyle="#ffffff",ctx.arc(e.x-t/2,height/2,sequenceOne.circleRadius,0,2*Math.PI),ctx.arc(e.x+t/2,height/2,sequenceOne.circleRadius,0,2*Math.PI),ctx.fill()):(ctx.strokeStyle="#ffffff",ctx.beginPath(),ctx.lineWidth=1,ctx.arc(e.x,height/2,sequenceOne.circleRadius,0,2*Math.PI),ctx.stroke(),ctx.beginPath(),ctx.lineWidth=3,ctx.arc(e.x,height/2,sequenceOne.circleRadius+.1*t*1.15,0,2*Math.PI),ctx.stroke());var o=e.x;0!=sequenceThree.x&&(o=sequenceThree.x),ctx.beginPath(),ctx.fillStyle="rgba(255,255,255,0.1)",ctx.arc(o,e.y,sequenceTwo.circleOne,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.fillStyle="rgba(255,255,255,0.1)",ctx.arc(o,e.y,sequenceTwo.circleTwo,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.fillStyle="rgba(255,255,255,0.5)",ctx.arc(o,e.y,sequenceTwo.circleThree,0,2*Math.PI),ctx.fill()}}function createBackgroundPlane(e){backgroundPlane=new THREE.Object3D,(new THREE.TextureLoader).load(e,function(e){var t=new THREE.MeshPhongMaterial({side:THREE.BackSide,depthWrite:!1,map:e,specular:328965,shininess:100,transparent:!0,opacity:0,emissive:1118481}),n=new THREE.SphereGeometry(14,32,32),a=n.faceVertexUvs[0];for(i=0;i<a.length;i++)for(var o=a[i],c=n.faces[i],r=0;r<3;r++)o[r].x=.5*c.vertexNormals[r].x+.5,o[r].y=.5*c.vertexNormals[r].y+.5;var s=new THREE.Mesh(n,t);backgroundPlane.add(s),scene.add(backgroundPlane)},function(){console.error("Error loading background-image-texture")})}var container,stats,camera,scene,renderer,objects,orbitControls,req,changeAnimation={planeOpacity:0,monolithOpacity:0,doAnimate:!1};function changeTexture(e){(new THREE.TextureLoader).load(e,function(e){TweenLite.killTweensOf(window),TweenLite.killTweensOf(changeAnimation),TweenLite.killTweensOf(camPos),changeAnimation.doAnimate=!0,TweenLite.to(camPos,2,{x:getRandomInt(-20,20),y:0,z:3,fov:40,ease:Quad.easeOut,onUpdate:animateCamTo}),TweenLite.to(changeAnimation,1,{planeOpacity:0,monolithOpacity:0,ease:Quad.easeOut,onComplete:function(){backgroundPlane.children[0].material.map=e,monolith.children[0].traverse(function(t){t instanceof THREE.Mesh&&(t.material.map=e)}),TweenLite.to(changeAnimation,2,{planeOpacity:1,monolithOpacity:1,ease:Quad.easeIn,onComplete:function(){TweenLite.to(camPos,3,{x:0,y:0,z:8,fov:40,ease:Expo.easeInOut,onUpdate:animateCamTo}),changeAnimation.doAnimate=!1}})}})},function(){console.error("Error loading background-image-texture")})}function animateChange(){changeAnimation.doAnimate&&(backgroundPlane.children[0].material.opacity=changeAnimation.planeOpacity,monolith.children[0].children[0].material.opacity=changeAnimation.monolithOpacity)}function addMonolith(){var e=new THREE.MeshPhongMaterial({color:16769185,specular:16777215,shininess:30,transparent:!0}),t=new THREE.LoadingManager;t.onProgress=function(e,t,n){};var n=new THREE.TextureLoader(t).load(imagePath+activeImage+".jpg");new THREE.OBJLoader(t).load("model/monolith.obj",function(t){t.traverse(function(t){if(t instanceof THREE.Mesh){t.material=e,t.material.map=n;var a=new THREE.PointsMaterial({color:16777215,size:.1,transparent:!0}),i=(new THREE.Points(t.geometry,a),new THREE.EdgesGeometry(t.geometry)),o=new THREE.LineBasicMaterial({color:16777215,linewidth:1,transparent:!0}),c=new THREE.LineSegments(i,o);t.add(c)}}),t.position.y=0;t.scale.x=.05,t.scale.y=.05,t.scale.z=.05,t.children[0].material.opacity=0;(new THREE.Box3).setFromObject(t).getCenter(t.position);t.position.multiplyScalar(-1),(monolith=new THREE.Object3D).add(t),scene.add(monolith)},function(e){e.lengthComputable&&(e.loaded,e.total)},function(e){})}function hoveringMonolith(e){null!=monolith&&doHoverMonolith&&(monolith.position.y=.1*Math.sin(.1*radians(e))+.1,monolith.rotation.y=.005*radians(e))}function rotatingScene(e){null!=scene&&(scene.rotation.y=.6+.005*radians(e))}Detector.webgl||Detector.addGetWebGLMessage();var monolith,kaleidoParams,kaleidoPass,composer,doAntialias=!0,doShadows=!1,camPos={x:0,y:1,z:8,fov:40},keepControlsAboveGround=!1,imagePath="images/",activeImage=12,kaleidoSettings={sides:24,angle:2},doHoverMonolith=!1,highDPI=!0,reduceResolution=!1,canvasScale=1,showPerformance=!1,lowPerformance=0,firstClick=!1,kaleidoActive=!1;function init(){if(jQuery(document).on("mousemove",function(e){null!=scene&&(kaleidoSettings.sides=map(e.pageX,0,width,1,24),kaleidoSettings.angle=map(e.pageY,0,height,0,2),kaleidoPass.uniforms.sides.value=kaleidoSettings.sides,kaleidoPass.uniforms.angle.value=3.1416*kaleidoSettings.angle)}),stats=new Stats,document.getElementById("Stats-output").appendChild(stats.dom),showPerformance?jQuery("#Stats-output div").css({display:"block"}):jQuery("#Stats-output div").css({display:"none"}),(renderer=new THREE.WebGLRenderer({preserveDrawingBuffer:!0,antialias:doAntialias})).setClearColor(12566463),highDPI&&renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),renderer.domElement.id="threeWebGL",renderer.toneMapping=THREE.LinearToneMapping,doShadows&&(renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.PCFSoftShadowMap),document.getElementById("WebGL-output").appendChild(renderer.domElement),scene=new THREE.Scene,(camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,1,2e3)).position.set(camPos.x,camPos.y,camPos.z),camera.fov=camPos.fov,(orbitControls=new THREE.OrbitControls(camera,renderer.domElement)).enableDamping=!0,orbitControls.dampingFactor=.1,orbitControls.minDistance=3,orbitControls.maxDistance=20,orbitControls.enablePan=!1,keepControlsAboveGround){var e=orbitControls.target.clone();e.y=0;var t=camera.position.clone();t.y=0;var n=e.distanceTo(t),a=new THREE.Vector2(orbitControls.target.y,0),i=new THREE.Vector2(0,n),o=Math.atan2(i.y-a.y,i.x-a.x);orbitControls.maxPolarAngle=o}var c=new THREE.HemisphereLight(16777200,1052704,1);c.position.set(.75,1,.25),scene.add(c),scene.add(new THREE.AmbientLight(16777215,.1));var r=new THREE.SpotLight(16777215,.5);r.position.set(50,100,50),r.angle=Math.PI/7,r.penumbra=.8,scene.add(r);var s=new THREE.SpotLight(16777215,.5);s.position.set(-50,-100,-50),s.angle=Math.PI/3,s.penumbra=.8,scene.add(s);var d=new THREE.RenderPass(scene,camera);kaleidoPass=new THREE.ShaderPass(THREE.KaleidoShader),(composer=new THREE.EffectComposer(renderer)).addPass(d),composer.addPass(kaleidoPass),kaleidoPass.renderToScreen=!0,kaleidoPass.uniforms.sides.value=kaleidoSettings.sides,kaleidoPass.uniforms.angle.value=3.1416*kaleidoSettings.angle,window.addEventListener("resize",onWindowResize,!1),onWindowResize(),createBackgroundPlane(imagePath+activeImage+".jpg"),addMonolith(),createAnimationCanvas(),startAnimationSequence(),animate()}function animate(){req=requestAnimationFrame(animate),render(),stats.update(),checkPerformance()}window.onload=init;var width,height,clock=new THREE.Clock,a=0,curFrame=0;function render(){curFrame++;var e=Date.now();clock.getDelta();animateChange(),hoveringMonolith(e),rotatingScene(e),animateCanvas(),checkForNoInteraction(),orbitControls.update(),null!=orbitControls&&null!=camera&&(camPos.x=orbitControls.object.position.x,camPos.y=orbitControls.object.position.y,camPos.z=orbitControls.object.position.z),kaleidoActive?composer.render(.1):renderer.render(scene,camera)}function onWindowResize(){if(width=window.innerWidth,height=window.innerHeight,null!=canvas&&(canvas.width=width,canvas.height=height),null!=camera&&(camera.aspect=width/height,camera.updateProjectionMatrix()),null!=renderer&&(renderer.setSize(width/canvasScale,height/canvasScale),1!=canvasScale&&jQuery("#WebGL-output canvas").css({width:width,height:height})),tutorialComplete){sequence_three();var e=.2*width;jQuery("#backgroundBox").css({width:e,height:e}),jQuery("#interactiveBox").css({opacity:1,left:width-.12*width-e/2,top:height/2-e/2}),rePositionDots()}}function animateCamTo(){orbitControls.object.position.x=camPos.x,orbitControls.object.position.y=camPos.y,orbitControls.object.position.z=camPos.z,camera.fov=camPos.fov,camera.lookAt(new THREE.Vector3(0,0,0)),camera.updateProjectionMatrix()}function radians(e){return e*(Math.PI/180)}function map(e,t,n,a,i){return a+(e-t)/(n-t)*(i-a)}function getRandomInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}var lowPerformanceStarted=0,steppedDown=0;function checkPerformance(){var e;!highDPI&&reduceResolution||(stats.getFPS()<49?(0==lowPerformanceStarted&&(lowPerformanceStarted=new Date),curTime=new Date,e=curTime-lowPerformanceStarted):lowPerformanceStarted=0,e>6e3&&(highDPI&&renderer.getPixelRatio()>1?(console.log("Note: Slow performance on this machine, reducing resolution to non-retina"),highDPI=!1,renderer.setPixelRatio(1),lowPerformance=0,lowPerformanceStarted=0):steppedDown<2?(console.log("Note: Slow performance on this machine, reducing resolution by 1.5 steps"),lowPerformanceStarted=0,highDPI=!1,0==steppedDown&&(canvasScale=1.5),1==steppedDown&&(canvasScale=3),renderer.setSize(window.innerWidth/canvasScale,window.innerHeight/canvasScale),jQuery("#WebGL-output canvas").css({width:width,height:height}),steppedDown++):reduceResolution=!0))}var clickDragHandler,checkForDragCount=0;function addInfoAnimation(){jQuery("#infoContainer").css({opacity:1,top:height/2-35,left:width/2-75});var e=[];clickDragHandler=function(t){e=[t.pageX,t.pageY],$(document).on("mousemove touchmove",function t(n){e=[n.pageX,n.pageY],$(document).off("mousemove touchmove",t)}),$(document).on("mouseup touchend",function t(n){n.pageX===e[0]&&n.pageY===e[1]?++checkForDragCount>2&&removeDragAnimation():removeDragAnimation(),$(document).off("mouseup touchend",t)})},$(document).on("mousedown touchstart",function(e){clickDragHandler(e)})}var tutorialComplete=!1;function removeDragAnimation(){tutorialComplete=!0,sequence_three(),activateButtons(),jQuery("#infoContainer img").attr("src","images/touch_small.gif"),jQuery("#infoContainer").css({left:width-200}),null!=clickDragHandler&&(jQuery(document).unbind("mousedown touchstart",clickDragHandler),clickDragHandler=function(){},jQuery(document).on("mousedown touchstart",function(e){firstClick||(firstClick=!0,jQuery("#infoContainer").css({opacity:0}))}))}var didReset=!1;function checkForNoInteraction(){curTime=new Date,timeDiff=curTime-lastInteraction,timeDiff>5e4&&(didReset||(sequenceOne={rect:{width:20,height:1},type:{size:0,spacing:0},circleRadius:5,rotation:0},sequenceTwo={circleOne:0,circleTwo:0,circleThree:0},sequenceThree={x:0},jQuery("#infoContainer img").attr("src","images/dragToRotate_small.gif"),jQuery("#interactiveBox").css({opacity:0}),TweenLite.to(monolith.children[0].children[0].material,2,{opacity:0,ease:Expo.easeIn}),TweenLite.to(backgroundPlane.children[0].material,2,{opacity:0,ease:Expo.easeIn}),sequence_one(),tutorialComplete=!1,didReset=!0,lastInteraction=void 0))}